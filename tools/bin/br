#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/br"

find_real_br() {
  if [[ -n "${BR_REAL_BIN:-}" && -x "${BR_REAL_BIN:-}" ]]; then
    echo "$BR_REAL_BIN"
    return 0
  fi

  if [[ -x "$HOME/.local/bin/br.real" ]]; then
    echo "$HOME/.local/bin/br.real"
    return 0
  fi

  IFS=':' read -r -a PATH_PARTS <<<"${PATH:-}"
  for PART in "${PATH_PARTS[@]}"; do
    [[ -z "$PART" ]] && continue
    CANDIDATE="$PART/br"
    if [[ "$CANDIDATE" == "$SCRIPT_PATH" ]]; then
      continue
    fi
    if [[ -x "$CANDIDATE" ]]; then
      echo "$CANDIDATE"
      return 0
    fi
  done

  return 1
}

REAL_BR="$(find_real_br)" || {
  echo "[cass-hook] Could not locate real br binary." >&2
  exit 127
}

if [[ "${1:-}" == "update" ]]; then
  REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
  if [[ -n "$REPO_ROOT" && -x "$REPO_ROOT/tools/br-update-with-cass.sh" && -d "$REPO_ROOT/.beads" ]]; then
    exec "$REPO_ROOT/tools/br-update-with-cass.sh" --br-bin "$REAL_BR" "${@:2}"
  fi
fi

exec "$REAL_BR" "$@"
